name: CI + Lint + SAST + SCA + DAST

on:
  workflow_dispatch:
  push:
    branches: [test, dev]
  pull_request:
    branches: [test, dev]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - run: npm run typecheck

  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: [typecheck]
    env:
      CI: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - name: Run Vitest
        run: npm run test:ci:unit
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/

  lint:
    name: ESLint Check
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - name: Run ESLint
        run: npm run lint
      - name: Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          if-no-files-found: ignore

  semgrep:
    name: Static Application Security Testing (Semgrep)
    runs-on: ubuntu-latest
    needs: [test]
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Semgrep & jq
        run: |
          python -m pip install --upgrade pip
          python -m pip install semgrep
          sudo apt-get update && sudo apt-get install -y jq
      - name: Semgrep JSON
        run: |
          semgrep scan \
            --config p/owasp-top-ten \
            --config p/javascript \
            --config p/typescript \
            --config p/react \
            --config p/secrets \
            --include 'src/**/*.ts' --include 'src/**/*.tsx' \
            --metrics=off \
            --json --output semgrep.json \
            .
      - name: Semgrep SARIF
        run: |
          semgrep scan \
            --config p/owasp-top-ten \
            --config p/javascript \
            --config p/typescript \
            --config p/react \
            --config p/secrets \
            --include 'src/**/*.ts' --include 'src/**/*.tsx' \
            --metrics=off \
            --sarif --output semgrep.sarif \
            .
      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
      - name: Job summary
        run: |
          echo "## Semgrep Summary" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(jq '.results | length' semgrep.json)
          FILES=$(jq '.paths.scanned | length' semgrep.json 2>/dev/null || echo 0)
          echo "- **Findings:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Files scanned:** $FILES" >> $GITHUB_STEP_SUMMARY
      - name: Upload raw artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results-${{ github.run_id }}
          path: |
            semgrep.json
            semgrep.sarif

  sca:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    needs: [test]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm ci
      - name: Run npm audit (JSON)
        run: |
          set -o pipefail
          npm audit --json > audit.json || true
      - name: Summarize audit in job summary
        run: |
          node <<'NODE'
          const fs = require('fs');
          const SUMMARY = process.env.GITHUB_STEP_SUMMARY;
          const path = 'audit.json';
          const data = fs.existsSync(path) ? JSON.parse(fs.readFileSync(path, 'utf8')) : {};
          const counts = (data.metadata && data.metadata.vulnerabilities) || data.vulnerabilities || {};
          const crit = counts.critical || 0;
          const high = counts.high || 0;
          const med  = counts.moderate ?? counts.medium ?? 0;
          const low  = counts.low || 0;
          const rows = [];
          if (data.vulnerabilities && typeof data.vulnerabilities === 'object') {
            for (const [name, v] of Object.entries(data.vulnerabilities)) {
              const sev = (v.severity || 'info').toLowerCase();
              const via = (v.via || [])
                .map(x => typeof x === 'string' ? x : x.title || x.name || '')
                .filter(Boolean)
                .slice(0, 3)
                .join('; ');
              const fix = v.fixAvailable
                ? (typeof v.fixAvailable === 'object'
                    ? `${v.fixAvailable.name || name}@${v.fixAvailable.version || ''}`.replace(/@$/, '')
                    : 'yes')
                : 'no';
              rows.push({
                name: '`' + name + '`',
                severity: sev,
                range: '`' + (v.range || v.version || '') + '`',
                via: via || '—',
                fix
              });
            }
          }
          const sevRank = s => ({critical:4, high:3, moderate:2, medium:2, low:1, info:0}[s]||0);
          rows.sort((a,b) => sevRank(b.severity) - sevRank(a.severity));
          let md = '';
          md += `## npm audit – Summary\n\n`;
          md += `- **Critical:** ${crit} · **High:** ${high} · **Moderate:** ${med} · **Low:** ${low}\n\n`;
          if (rows.length) {
            md += `### Top findings\n`;
            md += `| Package | Severity | Affected | Via (sample) | Fix available |\n`;
            md += `|---|---|---|---|---|\n`;
            for (const r of rows.slice(0, 20)) {
              md += `| ${r.name} | ${r.severity} | ${r.range} | ${r.via} | ${r.fix} |\n`;
            }
            if (rows.length > 20) md += `\n_…and ${rows.length - 20} more._\n`;
          } else {
            md += `✅ No vulnerabilities found.\n`;
          }
          fs.appendFileSync(SUMMARY, md);
          NODE
      - name: Fail on high/critical vulns
        env:
          ENFORCE: "true"
        run: |
          node -e "const r=require('./audit.json'); \
            const c=(r.metadata&&r.metadata.vulnerabilities)||r.vulnerabilities||{}; \
            const hi=(c.high||0), cr=(c.critical||0); \
            console.log('High:',hi,'Critical:',cr); \
            if (process.env.ENFORCE==='true' && (hi+cr)>0) { \
              console.error('Failing: high+critical =', hi+cr); process.exit(1) }"
      - name: Upload audit.json artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-${{ github.run_id }}
          path: audit.json

  zap-baseline:
    name: DAST (OWASP ZAP Baseline)
    runs-on: ubuntu-latest
    needs: [lint, semgrep, sca]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build

      - name: Start preview server (5173)
        run: |
          npx vite preview --host 127.0.0.1 --port 5173 --strictPort &
          echo $! > web_pid
      - name: Wait for frontend
        run: npx wait-on http-get://127.0.0.1:5173

      - name: Relax workspace perms for ZAP container
        run: chmod -R a+w .

      - name: OWASP ZAP Baseline Scan
        continue-on-error: true
        env:
          TARGET_URL: "http://127.0.0.1:5173"
        run: |
          set -euo pipefail
          docker pull ghcr.io/zaproxy/zaproxy:stable -q
          set +e
          docker run --rm \
            -v "$PWD":/zap/wrk/:rw \
            -w /zap/wrk \
            --network host \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "$TARGET_URL" \
              -J report_json.json \
              -w report_md.md \
              -r report_html.html \
              -j \
              -m 5 \
              -c ".zap/rules.tsv"
          EXIT_CODE=$?
          set -e
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "ZAP baseline exited with code $EXIT_CODE (ignored due to continue-on-error)" >&2
          fi
    
      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "zap-baseline-report-${{ github.run_id }}"
          path: |
            report_html.html
            report_md.md
            report_json.json

      - name: Stop preview
        if: always()
        run: kill $(cat web_pid) || true

  e2e:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    needs: [lint, semgrep, sca]
    if: >
      !github.event.pull_request.head.repo.fork && (
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'push' && github.ref == 'refs/heads/test') ||
        (github.event_name == 'pull_request' && github.base_ref == 'test')
      )
    env:
      CI: true
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with: { node-version: 20, cache: 'npm' }
    - run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright
      run: npm run test:ci:e2e
    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 20

  
