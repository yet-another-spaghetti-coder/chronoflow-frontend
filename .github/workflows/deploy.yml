name: ChronoFlow CI/CD Pipeline
run-name: Deploy to ${{ inputs.environment || 'dev' }} triggered by ${{ github.actor }}

on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main", "dev"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target Environment"
        required: true
        default: "dev"
        type: choice
        options: [dev, staging, prod]

permissions:
  contents: read
  actions: read
  pull-requests: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "25"
  PROJECT_NAME: "chronoflow"
  COST_CENTER: "cf-01"
  CI: true

jobs:
  # ====================================================
  # PHASE 1: Type Verification
  # ====================================================
  typecheck:
    name: "Type Verification"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - run: npm ci
      - run: npm run typecheck

  # ====================================================
  # PHASE 2: Unit & Integration Tests (NON-BLOCKING)
  # ====================================================
  test:
    name: "Unit & Integration Tests (non-blocking)"
    runs-on: ubuntu-latest
    needs: typecheck
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - run: npm ci
      - name: Execute Vitest
        run: npm run test:ci:unit
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage
          path: coverage/
          retention-days: 7

  # ====================================================
  # PHASE 3: Code Quality & Security (DO NOT NEED TEST)
  # ====================================================
  lint:
    name: "ESLint Analysis"
    runs-on: ubuntu-latest
    needs: typecheck
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - run: npm ci
      - run: npm run lint
      - name: Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: eslint-report
          path: eslint-report.json
          if-no-files-found: ignore

  semgrep:
    name: "SAST (Semgrep)"
    runs-on: ubuntu-latest
    needs: typecheck
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - uses: actions/checkout@v6
      - uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest
      - uses: actions/setup-python@v6
        with:
          python-version: "3.14"
      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          python -m pip install semgrep
      - name: Semgrep Scan with Reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semgrep scan \
            --config p/owasp-top-ten \
            --config p/javascript \
            --config p/typescript \
            --config p/react \
            --config p/secrets \
            --include 'src/**/*.ts' --include 'src/**/*.tsx' \
            --metrics=off \
            --sarif \
            | reviewdog -f=sarif -name="Semgrep" -reporter=github-pr-review -filter-mode=nofilter -fail-on-error=false -level=warning
      - name: Semgrep Scan (Artifact Generation)
        if: always()
        run: |
          semgrep scan \
            --config p/owasp-top-ten \
            --config p/javascript \
            --config p/typescript \
            --config p/react \
            --config p/secrets \
            --include 'src/**/*.ts' --include 'src/**/*.tsx' \
            --metrics=off \
            --sarif --output semgrep.sarif \
            || true
      - name: Upload Semgrep artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: semgrep-results-${{ github.run_id }}
          path: semgrep.sarif
          if-no-files-found: ignore

  sca:
    name: "SCA (npm audit)"
    runs-on: ubuntu-latest
    needs: typecheck
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - run: npm ci
      - name: Execute npm audit (production scope)
        run: |
          set -o pipefail
          npm audit --omit=dev --json > audit.json || true
      - name: Generate Audit Summary
        run: |
          node <<'NODE'
          const fs = require('fs');
          const SUMMARY = process.env.GITHUB_STEP_SUMMARY;
          const path = 'audit.json';
          const data = fs.existsSync(path) ? JSON.parse(fs.readFileSync(path, 'utf8')) : {};
          const counts = (data.metadata && data.metadata.vulnerabilities) || data.vulnerabilities || {};
          const crit = counts.critical || 0;
          const high = counts.high || 0;
          let md = `## npm audit â€“ Summary\n\n`;
          md += `- Critical: ${crit}\n- High: ${high}\n`;
          md += (crit + high === 0)
            ? `No critical or high vulnerabilities found in production dependencies.\n`
            : `Critical or high vulnerabilities detected. Please review artifacts.\n`;
          fs.appendFileSync(SUMMARY, md);
          NODE
      - name: Enforce security policy
        env:
          ENFORCE: "true"
        run: |
          node -e "const r=require('./audit.json'); \
            const c=(r.metadata&&r.metadata.vulnerabilities)||r.vulnerabilities||{}; \
            const hi=(c.high||0), cr=(c.critical||0); \
            if (process.env.ENFORCE==='true' && (hi+cr)>0) { \
              console.error('Failure: Production dependencies have', hi+cr, 'high/critical vulnerabilities'); \
              process.exit(1) \
            } else { \
              console.log('No critical/high vulnerabilities in production dependencies'); \
            }"
      - name: Upload audit artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: npm-audit-${{ github.run_id }}
          path: audit.json

  dependency-review:
    name: "Dependency Review"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
      - uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always

  secret-scan:
    name: "Secret Scanning (TruffleHog)"
    runs-on: ubuntu-latest
    needs: typecheck
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          base: ""
          head: ${{ github.ref }}
          extra_args: --debug --only-verified

  # ====================================================
  # PHASE 4: Build & Optimize
  # ====================================================
  build:
    name: "Build & Optimize"
    needs: [lint, semgrep, sca, secret-scan]
    runs-on: ubuntu-latest
    outputs:
      build-hash: ${{ steps.hash.outputs.hash }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - run: npm ci
      - name: Set Build Environment
        run: |
          ENV="${{ inputs.environment || 'dev' }}"
          echo "VITE_ENV=${ENV}" >> $GITHUB_ENV
          echo "Building for environment: ${ENV}"
      - name: Build Application
        run: npm run build
        env:
          NODE_ENV: production
          GENERATE_SOURCEMAP: true
      - name: Generate Build Hash
        id: hash
        run: |
          BUILD_HASH=$(find dist -type f -exec md5sum {} \; | sort | md5sum | cut -d' ' -f1)
          echo "hash=${BUILD_HASH}" >> $GITHUB_OUTPUT
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v6
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 7
          compression-level: 9

  # ====================================================
  # PHASE 5: E2E & DAST
  # ====================================================
  e2e:
    name: "Playwright E2E Tests"
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - run: npm ci
      - uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist
      - run: npx playwright install --with-deps
      - run: npm run test:ci:e2e
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 20

  dast:
    name: "DAST (OWASP ZAP)"
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
      - run: npm ci
      - uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist
      - name: Start preview server
        run: |
          npx vite preview --host 127.0.0.1 --port 5173 --strictPort &
          echo $! > web_pid
      - run: npx wait-on http-get://127.0.0.1:5173
      - run: chmod -R a+w .
      - name: Execute OWASP ZAP Baseline Scan
        continue-on-error: true
        env:
          TARGET_URL: "http://127.0.0.1:5173"
        run: |
          set -euo pipefail
          docker pull ghcr.io/zaproxy/zaproxy:stable -q
          set +e
          docker run --rm \
            -v "$PWD":/zap/wrk/:rw \
            -w /zap/wrk \
            --network host \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "$TARGET_URL" \
              -J report_json.json \
              -w report_md.md \
              -r report_html.html \
              -j \
              -m 5 \
              -c ".zap/rules.tsv"
          EXIT_CODE=$?
          set -e
          echo "ZAP scan completed with exit code: $EXIT_CODE"
      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: zap-baseline-report-${{ github.run_id }}
          path: |
            report_html.html
            report_md.md
            report_json.json
      - name: Stop preview server
        if: always()
        run: kill $(cat web_pid) || true